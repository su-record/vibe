#!/usr/bin/env node

/**
 * vibe CLI
 * SPEC-driven AI coding framework (Claude Code ì „ìš©)
 */

const path = require('path');
const fs = require('fs');

const args = process.argv.slice(2);
const command = args[0];

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
function ensureDir(dir) {
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
}

function copyDirContents(sourceDir, targetDir) {
  if (fs.existsSync(sourceDir)) {
    fs.readdirSync(sourceDir).forEach(file => {
      fs.copyFileSync(path.join(sourceDir, file), path.join(targetDir, file));
    });
  }
}

function copyDirRecursive(sourceDir, targetDir) {
  if (!fs.existsSync(sourceDir)) return;

  ensureDir(targetDir);

  fs.readdirSync(sourceDir).forEach(item => {
    const sourcePath = path.join(sourceDir, item);
    const targetPath = path.join(targetDir, item);

    if (fs.statSync(sourcePath).isDirectory()) {
      copyDirRecursive(sourcePath, targetPath);
    } else {
      fs.copyFileSync(sourcePath, targetPath);
    }
  });
}

// í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
async function init(projectName) {
  try {
    let projectRoot = process.cwd();
    let isNewProject = false;

    if (projectName) {
      projectRoot = path.join(process.cwd(), projectName);

      if (fs.existsSync(projectRoot)) {
        console.log(`âŒ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: ${projectName}/`);
        return;
      }

      console.log(`ğŸ“ ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±: ${projectName}/\n`);
      fs.mkdirSync(projectRoot, { recursive: true });
      isNewProject = true;
    }

    const vibeDir = path.join(projectRoot, '.vibe');
    if (fs.existsSync(vibeDir)) {
      console.log('âŒ .vibe/ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
      return;
    }

    // MCP ì„œë²„ ë“±ë¡ (Claude Code)
    const mcpPath = path.join(__dirname, '..', 'node_modules', '@su-record', 'hi-ai', 'dist', 'index.js');

    console.log('ğŸ”§ Claude Code MCP ì„œë²„ ë“±ë¡ ì¤‘...\n');
    const { execSync } = require('child_process');
    try {
      execSync(`claude mcp add vibe node "${mcpPath}"`, { stdio: 'pipe' });
      console.log('   âœ… MCP ì„œë²„ ë“±ë¡ ì™„ë£Œ\n');
    } catch (e) {
      if (e.message.includes('already exists')) {
        console.log('   â„¹ï¸  MCP ì„œë²„ ì´ë¯¸ ë“±ë¡ë¨\n');
      } else {
        console.log('   âš ï¸  MCP ìˆ˜ë™ ë“±ë¡ í•„ìš”\n');
      }
    }

    // .vibe í´ë” êµ¬ì¡° ìƒì„±
    const dirs = ['', 'specs', 'features'];
    dirs.forEach(dir => {
      ensureDir(path.join(vibeDir, dir));
    });

    // .claude/commands ë³µì‚¬
    const claudeDir = path.join(projectRoot, '.claude');
    const commandsDir = path.join(claudeDir, 'commands');
    ensureDir(claudeDir);
    ensureDir(commandsDir);

    const sourceDir = path.join(__dirname, '../.claude/commands');
    copyDirContents(sourceDir, commandsDir);
    console.log('   âœ… ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ì„¤ì¹˜ ì™„ë£Œ (7ê°œ)\n');

    // ì„¤ì • íŒŒì¼ ìƒì„±
    const templatePath = path.join(__dirname, '../templates/constitution-template.md');
    const constitutionPath = path.join(vibeDir, 'constitution.md');
    if (fs.existsSync(templatePath)) {
      fs.copyFileSync(templatePath, constitutionPath);
    }

    const config = {
      language: 'ko',
      quality: { strict: true, autoVerify: true }
    };
    fs.writeFileSync(path.join(vibeDir, 'config.json'), JSON.stringify(config, null, 2));

    // CLAUDE.md ë³µì‚¬
    const agentsSource = path.join(__dirname, '../CLAUDE.md');
    const agentsDest = path.join(projectRoot, 'CLAUDE.md');
    if (fs.existsSync(agentsSource)) {
      fs.copyFileSync(agentsSource, agentsDest);
    }

    // .agent/rules/ ë³µì‚¬ (ì½”ë”© ê·œì¹™)
    const rulesSource = path.join(__dirname, '../.agent/rules');
    const rulesTarget = path.join(projectRoot, '.agent/rules');
    copyDirRecursive(rulesSource, rulesTarget);
    console.log('   âœ… ì½”ë”© ê·œì¹™ ì„¤ì¹˜ ì™„ë£Œ (.agent/rules/)\n');

    // .claude/agents/ ë³µì‚¬ (ì„œë¸Œì—ì´ì „íŠ¸)
    const agentsDir = path.join(claudeDir, 'agents');
    ensureDir(agentsDir);
    const agentsSourceDir = path.join(__dirname, '../.claude/agents');
    copyDirContents(agentsSourceDir, agentsDir);
    console.log('   âœ… ì„œë¸Œì—ì´ì „íŠ¸ ì„¤ì¹˜ ì™„ë£Œ (.claude/agents/)\n');

    // ì™„ë£Œ ë©”ì‹œì§€
    console.log(`
âœ… vibe ì´ˆê¸°í™” ì™„ë£Œ!

${isNewProject ? `í”„ë¡œì íŠ¸ ìœ„ì¹˜:
  ${projectRoot}/

` : ''}ìƒì„±ëœ êµ¬ì¡°:
  CLAUDE.md                      # í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸
  .claude/
  â”œâ”€â”€ commands/                  # ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ (7ê°œ)
  â””â”€â”€ agents/                    # ì„œë¸Œì—ì´ì „íŠ¸ (simplifier)
  .agent/rules/                  # ì½”ë”© ê·œì¹™
  â”œâ”€â”€ core/                      # í•µì‹¬ ì›ì¹™
  â”œâ”€â”€ quality/                   # í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
  â””â”€â”€ standards/                 # ì½”ë”© í‘œì¤€
  .vibe/
  â”œâ”€â”€ config.json                # í”„ë¡œì íŠ¸ ì„¤ì •
  â”œâ”€â”€ constitution.md            # í”„ë¡œì íŠ¸ ì›ì¹™
  â”œâ”€â”€ specs/                     # SPEC ë¬¸ì„œë“¤
  â””â”€â”€ features/                  # BDD Feature íŒŒì¼ë“¤

MCP ì„œë²„ (hi-ai): âœ“

ì‚¬ìš©ë²•:
  /vibe.spec "ê¸°ëŠ¥ëª…"            SPEC ì‘ì„± (ëŒ€í™”í˜•)
  /vibe.run "ê¸°ëŠ¥ëª…"             êµ¬í˜„ ì‹¤í–‰
  /vibe.verify "ê¸°ëŠ¥ëª…"          ê²€ì¦

ë‹¤ìŒ ë‹¨ê³„:
  ${isNewProject ? `cd ${projectName}\n  ` : ''}/vibe.spec "ê¸°ëŠ¥ëª…" ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”!
    `);

  } catch (error) {
    console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', error.message);
    process.exit(1);
  }
}

// ë„ì›€ë§ ì¶œë ¥
function showHelp() {
  console.log(`
ğŸ“– Vibe - SPEC-driven AI coding framework (Claude Code ì „ìš©)

Commands:
  vibe init [project]     Initialize vibe in current/new project
  vibe help               Show this message
  vibe version            Show version

Claude Code ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ:
  /vibe.spec "ê¸°ëŠ¥ëª…"     SPEC ì‘ì„± (PTCF êµ¬ì¡°)
  /vibe.run "ê¸°ëŠ¥ëª…"      êµ¬í˜„ ì‹¤í–‰
  /vibe.verify "ê¸°ëŠ¥ëª…"   ê²€ì¦
  /vibe.reason "ë¬¸ì œ"     ì²´ê³„ì  ì¶”ë¡ 
  /vibe.analyze           í”„ë¡œì íŠ¸ ë¶„ì„
  /vibe.ui "ì„¤ëª…"         UI ë¯¸ë¦¬ë³´ê¸°
  /vibe.diagram           ë‹¤ì´ì–´ê·¸ë¨ ìƒì„±

Workflow:
  /vibe.spec â†’ /vibe.run â†’ /vibe.verify

ì„¤ì¹˜:
  npm install -g @su-record/vibe

ë¬¸ì„œ:
  https://github.com/su-record/vibe
  `);
}

// ë²„ì „ ì •ë³´
function showVersion() {
  const packageJson = require('../package.json');
  console.log(`vibe v${packageJson.version}`);
}

// ë©”ì¸ ë¼ìš°í„°
switch (command) {
  case 'init':
    init(args[1]);
    break;

  case 'version':
  case '-v':
  case '--version':
    showVersion();
    break;

  case 'help':
  case '-h':
  case '--help':
  case undefined:
    showHelp();
    break;

  default:
    console.log(`
âŒ ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: ${command}

ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:
  vibe init       í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
  vibe help       ë„ì›€ë§
  vibe version    ë²„ì „ ì •ë³´

ì‚¬ìš©ë²•: vibe help
    `);
    process.exit(1);
}
