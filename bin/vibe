#!/usr/bin/env node

/**
 * vibe CLI
 * Vibe Development - SPEC-driven AI coding framework
 */

const path = require('path');
const fs = require('fs');

// ëª…ë ¹ì–´ ëª©ë¡ (Claude Code ì „ìš©)
const commands = {
  init: 'Initialize vibe in current project (MCP registration)',
  help: 'Show help message'
};

const args = process.argv.slice(2);
const command = args[0];

// ë„ì›€ë§ ì¶œë ¥
function showHelp() {
  console.log(`
ğŸ“– Vibe - SPEC-driven AI coding framework for Claude Code

âš ï¸  VibeëŠ” Claude Code ì „ìš© í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤.
   í„°ë¯¸ë„ì—ì„œëŠ” ì´ˆê¸°í™”ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.

í„°ë¯¸ë„ ëª…ë ¹ì–´:
  vibe init                  Initialize vibe in current project
  vibe init <project-name>   Create new project with vibe
  vibe help                  Show this message

Claude Code ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ (í”„ë¡œì íŠ¸ ë‚´ì—ì„œ ì‚¬ìš©):
  /vibe.spec "ê¸°ëŠ¥ëª…"       SPEC ì‘ì„± (ëŒ€í™”í˜• Q&A)
  /vibe.plan "ê¸°ëŠ¥ëª…"       ê¸°ìˆ  ê³„íš ì‘ì„±
  /vibe.tasks "ê¸°ëŠ¥ëª…"      Task ëª©ë¡ ìƒì„±
  /vibe.run "Task 1-1"      Task êµ¬í˜„
  /vibe.verify "ê¸°ëŠ¥ëª…"     ê²€ì¦
  /vibe.analyze             í”„ë¡œì íŠ¸ ë¶„ì„
  /vibe.ui "ì„¤ëª…"           UI ë¯¸ë¦¬ë³´ê¸°
  /vibe.diagram --er        ë‹¤ì´ì–´ê·¸ë¨ ìƒì„±

Workflow:
  1. í„°ë¯¸ë„ì—ì„œ vibe init ì‹¤í–‰ (MCP ì„œë²„ ë“±ë¡)
  2. Claude Codeì—ì„œ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ì‚¬ìš©
     /vibe.spec "í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •"
     /vibe.plan "í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •"
     /vibe.tasks "í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •"
     /vibe.run "Task 1-1"
     /vibe.verify "í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •"

ì„¤ì¹˜:
  npm install -g @su-record/vibe

ë¬¸ì„œ:
  https://github.com/su-record/vibe/wiki
  `);
}

// ë²„ì „ ì •ë³´
function showVersion() {
  const packageJson = require('../package.json');
  console.log(`vibe v${packageJson.version}`);
}

// í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
function init(projectName) {
  let projectRoot = process.cwd();
  let isNewProject = false;

  // ìƒˆ í”„ë¡œì íŠ¸ ìƒì„± ì¼€ì´ìŠ¤
  if (projectName) {
    projectRoot = path.join(process.cwd(), projectName);

    if (fs.existsSync(projectRoot)) {
      console.log(`âŒ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: ${projectName}/`);
      return;
    }

    console.log(`ğŸ“ ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±: ${projectName}/\n`);
    fs.mkdirSync(projectRoot, { recursive: true });
    isNewProject = true;
  }

  const vibeDir = path.join(projectRoot, '.vibe');

  if (fs.existsSync(vibeDir)) {
    console.log('âŒ .vibe/ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
    return;
  }

  // MCP ì„œë²„ ë“±ë¡ ë¨¼ì € ì²´í¬ ë° ì‹¤í–‰
  console.log('ğŸ”§ MCP ì„œë²„ í™•ì¸ ì¤‘...\n');
  try {
    const { execSync } = require('child_process');

    // MCP ì„œë²„ ë“±ë¡ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    const installScriptPath = path.join(__dirname, '../scripts/install-mcp.js');
    execSync(`node "${installScriptPath}"`, { stdio: 'inherit' });

  } catch (error) {
    console.log('\nâš ï¸  MCP ì„œë²„ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    console.log('   ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤...\n');
  }

  // í´ë” ìƒì„±
  fs.mkdirSync(vibeDir);
  fs.mkdirSync(path.join(vibeDir, 'specs'));
  fs.mkdirSync(path.join(vibeDir, 'plans'));
  fs.mkdirSync(path.join(vibeDir, 'tasks'));

  // .claude/commands í´ë” ìƒì„± ë° ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë³µì‚¬
  const claudeDir = path.join(projectRoot, '.claude');
  const commandsDir = path.join(claudeDir, 'commands');

  if (!fs.existsSync(claudeDir)) {
    fs.mkdirSync(claudeDir);
  }
  if (!fs.existsSync(commandsDir)) {
    fs.mkdirSync(commandsDir);
  }

  // ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ íŒŒì¼ë“¤ ë³µì‚¬
  const sourceCommandsDir = path.join(__dirname, '../.claude/commands');
  if (fs.existsSync(sourceCommandsDir)) {
    const commandFiles = fs.readdirSync(sourceCommandsDir);
    commandFiles.forEach(file => {
      const sourcePath = path.join(sourceCommandsDir, file);
      const destPath = path.join(commandsDir, file);
      fs.copyFileSync(sourcePath, destPath);
    });
  }

  // constitution.md í…œí”Œë¦¿ ë³µì‚¬
  const templatePath = path.join(__dirname, '../templates/constitution-template.md');
  const constitutionPath = path.join(vibeDir, 'constitution.md');

  if (fs.existsSync(templatePath)) {
    fs.copyFileSync(templatePath, constitutionPath);
  }

  // config.json ìƒì„± (ì–¸ì–´ ì„¤ì • í¬í•¨)
  const configPath = path.join(vibeDir, 'config.json');
  const config = {
    language: 'ko',  // ê¸°ë³¸ í•œêµ­ì–´
    agents: {
      default: 'backend-python-expert'
    },
    mcp: {
      enabled: true,
      servers: ['vibe']
    },
    quality: {
      strict: true,
      autoVerify: true
    }
  };
  fs.writeFileSync(configPath, JSON.stringify(config, null, 2));

  console.log(`
âœ… vibe ì´ˆê¸°í™” ì™„ë£Œ!

${isNewProject ? `í”„ë¡œì íŠ¸ ìœ„ì¹˜:
  ${projectRoot}/

` : ''}ìƒì„±ëœ êµ¬ì¡°:
  .claude/commands/     # ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ (8ê°œ)
  .vibe/
  â”œâ”€â”€ config.json       # í”„ë¡œì íŠ¸ ì„¤ì • (ì–¸ì–´: í•œêµ­ì–´)
  â”œâ”€â”€ constitution.md    # í”„ë¡œì íŠ¸ ì›ì¹™
  â”œâ”€â”€ specs/            # SPEC ë¬¸ì„œë“¤
  â”œâ”€â”€ plans/            # ê¸°ìˆ  ê³„íšë“¤
  â””â”€â”€ tasks/            # ì‘ì—… ëª©ë¡ë“¤

MCP ì„œë²„:
  âœ“ vibe MCP ì„œë²„ ë“±ë¡ ì™„ë£Œ (38ê°œ ë„êµ¬)
  í™•ì¸: claude mcp list

ì–¸ì–´ ë³€ê²½:
  .vibe/config.jsonì—ì„œ "language"ë¥¼ "en" ë˜ëŠ” "ko"ë¡œ ë³€ê²½

ë‹¤ìŒ ë‹¨ê³„:
  ${isNewProject ? `1. cd ${projectName}\n  2. ` : ''}Claude Codeì—ì„œ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ì‚¬ìš©:
     /vibe.spec "ê¸°ëŠ¥ëª…"
     /vibe.plan "ê¸°ëŠ¥ëª…"
  `);
}


// ë©”ì¸ ë¼ìš°í„°
switch (command) {
  case 'init':
    init(args[1]);
    break;

  case 'version':
  case '-v':
  case '--version':
    showVersion();
    break;

  case 'help':
  case '-h':
  case '--help':
  case undefined:
    showHelp();
    break;

  default:
    console.log(`
âŒ ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: ${command}

âš ï¸  VibeëŠ” Claude Code ì „ìš© í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤.
   í„°ë¯¸ë„ì—ì„œëŠ” 'init'ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

Claude Codeì—ì„œ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:
  /vibe.spec "ê¸°ëŠ¥ëª…"
  /vibe.plan "ê¸°ëŠ¥ëª…"
  /vibe.tasks "ê¸°ëŠ¥ëª…"
  /vibe.run "Task 1-1"

ì‚¬ìš©ë²•: vibe help
    `);
    process.exit(1);
}
