#!/usr/bin/env node

/**
 * vide CLI
 * Vibe Development - SPEC-driven AI coding framework
 */

const path = require('path');
const fs = require('fs');

// ëª…ë ¹ì–´ ëª©ë¡
const commands = {
  init: 'Initialize vide in current project',
  spec: 'Create/manage SPEC documents',
  plan: 'Create technical implementation plan',
  tasks: 'Break down SPEC into actionable tasks',
  run: 'Run task implementation (with auto guide generation)',
  verify: 'Verify implementation against SPEC',
  analyze: 'Analyze project (code quality, architecture, dependencies)',
  ui: 'Preview UI with ASCII art',
  diagram: 'Generate diagrams (architecture, ERD, flow)',
  agents: 'List available agents',
  skills: 'List installed skills',
  help: 'Show help message'
};

const args = process.argv.slice(2);
const command = args[0];

// ë„ì›€ë§ ì¶œë ¥
function showHelp() {
  console.log(`
ğŸ“– vide - Your story becomes code

Usage:
  vide <command> [options]

Commands:
  init                           Initialize vide in current project
  spec <name>                    Create SPEC through 6-question Q&A
  plan <name>                    Create implementation plan from SPEC
  tasks <name>                   Generate tasks from SPEC + PLAN
  run <task-id>                  Run task (auto-guide + implement)
  run --phase <N>                Run all tasks in Phase N
  run --all                      Run all tasks sequentially
  verify <name>                  Verify against SPEC requirements

  analyze                        Analyze project (code/deps/arch)
  analyze --code                 Code quality analysis
  analyze --deps                 Dependency analysis
  ui <description>               Preview UI with ASCII art
  diagram                        Generate architecture diagram
  diagram --er                   Generate ERD diagram

  agents                         List available agents
  skills                         List installed skills
  help                           Show this message

Workflow:
  1. vide spec "ê¸°ëŠ¥ëª…"              â†’ SPEC ì‘ì„± (Q&A)
  2. vide plan "ê¸°ëŠ¥ëª…"              â†’ PLAN ì‘ì„± (ê¸°ìˆ  ê³„íš)
  3. vide tasks "ê¸°ëŠ¥ëª…"             â†’ TASKS ìƒì„± (19ê°œ Task)
  4. vide run "Task 1-1"             â†’ Task êµ¬í˜„ (ê°€ì´ë“œ ìƒì„± + ì½”ë“œ ì‘ì„±)
  5. vide verify "ê¸°ëŠ¥ëª…"            â†’ SPEC ê²€ì¦

Examples:
  $ vide init
  $ vide story create "í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •"
  $ vide plan "í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •"
  $ vide tasks "í‘¸ì‹œ ì•Œë¦¼ ì„¤ì •"
  $ vide run "Task 1-1"              # ê°œë³„ Task ì‹¤í–‰
  $ vide run --phase 1               # Phase 1 ì „ì²´ ì‹¤í–‰
  $ vide run --all                   # ì „ì²´ ì‹¤í–‰

More info:
  https://github.com/your-username/vide
  `);
}

// ë²„ì „ ì •ë³´
function showVersion() {
  const packageJson = require('../package.json');
  console.log(`vide v${packageJson.version}`);
}

// í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
function init() {
  const videDir = path.join(process.cwd(), '.vide');

  if (fs.existsSync(videDir)) {
    console.log('âŒ .vide/ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
    return;
  }

  // í´ë” ìƒì„±
  fs.mkdirSync(videDir);
  fs.mkdirSync(path.join(videDir, 'specs'));
  fs.mkdirSync(path.join(videDir, 'plans'));
  fs.mkdirSync(path.join(videDir, 'tasks'));

  // constitution.md í…œí”Œë¦¿ ë³µì‚¬
  const templatePath = path.join(__dirname, '../templates/constitution-template.md');
  const constitutionPath = path.join(videDir, 'constitution.md');

  if (fs.existsSync(templatePath)) {
    fs.copyFileSync(templatePath, constitutionPath);
  }

  // config.json ìƒì„± (ì–¸ì–´ ì„¤ì • í¬í•¨)
  const configPath = path.join(videDir, 'config.json');
  const config = {
    language: 'ko',  // ê¸°ë³¸ í•œêµ­ì–´
    agents: {
      default: 'backend-python-expert'
    },
    mcp: {
      enabled: true,
      servers: ['hi-ai', 'context-7']
    },
    quality: {
      strict: true,
      autoVerify: true
    }
  };
  fs.writeFileSync(configPath, JSON.stringify(config, null, 2));

  console.log(`
âœ… vide ì´ˆê¸°í™” ì™„ë£Œ!

ìƒì„±ëœ êµ¬ì¡°:
  .vide/
  â”œâ”€â”€ config.json       # í”„ë¡œì íŠ¸ ì„¤ì • (ì–¸ì–´: í•œêµ­ì–´)
  â”œâ”€â”€ constitution.md    # í”„ë¡œì íŠ¸ ì›ì¹™
  â”œâ”€â”€ specs/            # SPEC ë¬¸ì„œë“¤
  â”œâ”€â”€ plans/            # ê¸°ìˆ  ê³„íšë“¤
  â””â”€â”€ tasks/            # ì‘ì—… ëª©ë¡ë“¤

ì–¸ì–´ ë³€ê²½:
  .vide/config.jsonì—ì„œ "language"ë¥¼ "en" ë˜ëŠ” "ko"ë¡œ ë³€ê²½

ë‹¤ìŒ ë‹¨ê³„:
  vide story create "ê¸°ëŠ¥ëª…"  - ìƒˆ ê¸°ëŠ¥ ìŠ¤í† ë¦¬ ì‘ì„±
  `);
}

// ì—ì´ì „íŠ¸ ëª©ë¡
function listAgents() {
  const agentsDir = path.join(__dirname, '../agents');
  const agents = fs.readdirSync(agentsDir).filter(f => f.endsWith('.md'));

  console.log('\nğŸ¤– ì‚¬ìš© ê°€ëŠ¥í•œ ì—ì´ì „íŠ¸:\n');
  agents.forEach((agent, i) => {
    const name = agent.replace('.md', '');
    console.log(`  ${i + 1}. ${name}`);
  });
  console.log('');
}

// ìŠ¤í‚¬ ëª©ë¡
function listSkills() {
  const skillsDir = path.join(__dirname, '../skills');
  const categories = fs.readdirSync(skillsDir).filter(f => {
    return fs.statSync(path.join(skillsDir, f)).isDirectory();
  });

  console.log('\nğŸ“š ì„¤ì¹˜ëœ ìŠ¤í‚¬:\n');
  categories.forEach(category => {
    const skills = fs.readdirSync(path.join(skillsDir, category))
      .filter(f => f.endsWith('.md'));
    console.log(`  ${category}/`);
    skills.forEach(skill => {
      console.log(`    - ${skill.replace('.md', '')}`);
    });
  });
  console.log('');
}

// Claude Codeì™€ í†µí•© (ì¶”í›„ êµ¬í˜„)
function delegateToClaudeCode(command, args) {
  console.log(`
âš ï¸  ì´ ëª…ë ¹ì–´ëŠ” Claude Codeì™€ í†µí•©ì´ í•„ìš”í•©ë‹ˆë‹¤.

ì§€ê¸ˆì€ ìˆ˜ë™ìœ¼ë¡œ Claude Codeë¥¼ ì—´ê³  ë‹¤ìŒê³¼ ê°™ì´ ìš”ì²­í•˜ì„¸ìš”:

  "${command} ${args.join(' ')}"

í–¥í›„ ì—…ë°ì´íŠ¸ì—ì„œ ìë™í™”ë  ì˜ˆì •ì…ë‹ˆë‹¤.
  `);
}

// ë©”ì¸ ë¼ìš°í„°
switch (command) {
  case 'init':
    init();
    break;

  case 'agents':
    listAgents();
    break;

  case 'skills':
    listSkills();
    break;

  case 'version':
  case '-v':
  case '--version':
    showVersion();
    break;

  case 'help':
  case '-h':
  case '--help':
  case undefined:
    showHelp();
    break;

  // vide run ëª…ë ¹ì–´ (ìƒˆë¡œìš´ êµ¬í˜„ ì›Œí¬í”Œë¡œìš°)
  case 'run':
    handleRunCommand(args.slice(1));
    break;

  // Claude Code ìœ„ì„ì´ í•„ìš”í•œ ëª…ë ¹ì–´ë“¤
  case 'spec':
  case 'plan':
  case 'tasks':
  case 'verify':
  case 'analyze':
  case 'ui':
  case 'diagram':
    delegateToClaudeCode(command, args.slice(1));
    break;

  default:
    console.log(`âŒ ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: ${command}`);
    console.log('ì‚¬ìš©ë²•ì„ ë³´ë ¤ë©´: vide help');
    process.exit(1);
}

// vide run ëª…ë ¹ì–´ í•¸ë“¤ëŸ¬
function handleRunCommand(args) {
  const option = args[0];

  if (!option) {
    console.log(`
âŒ ì‚¬ìš©ë²•: vide run <task-id> | --phase <N> | --all

ì˜ˆì‹œ:
  vide run "Task 1-1"        # íŠ¹ì • Task ì‹¤í–‰
  vide run --phase 1         # Phase 1 ì „ì²´ ì‹¤í–‰
  vide run --all             # ëª¨ë“  Task ì‹¤í–‰
    `);
    return;
  }

  // --all í”Œë˜ê·¸ ì²˜ë¦¬
  if (option === '--all') {
    console.log(`
ğŸš€ ì „ì²´ Task ì‹¤í–‰ ì‹œì‘...

Claude Codeì— ë‹¤ìŒê³¼ ê°™ì´ ìš”ì²­í•˜ì„¸ìš”:

  "vide run --all ì‹¤í–‰í•´ì¤˜. TASKS ë¬¸ì„œì˜ ì˜ì¡´ì„± ìˆœì„œëŒ€ë¡œ 19ê°œ Taskë¥¼ ëª¨ë‘ êµ¬í˜„í•´ì¤˜."

ì‘ì—… ìˆœì„œ:
  Phase 1 (Backend) â†’ Task 1-1 ~ 1-8
  Phase 2 (Frontend) â†’ Task 2-1 ~ 2-8
  Phase 3 (FCM) â†’ Task 3-1 ~ 3-3

âš ï¸  ì£¼ì˜: ì „ì²´ ì‹¤í–‰ì€ ì•½ 24ì‹œê°„ ì†Œìš”ë©ë‹ˆë‹¤.
    `);
    return;
  }

  // --phase í”Œë˜ê·¸ ì²˜ë¦¬
  if (option === '--phase') {
    const phaseNumber = args[1];
    if (!phaseNumber) {
      console.log(`âŒ Phase ë²ˆí˜¸ë¥¼ ì§€ì •í•˜ì„¸ìš”: vide run --phase <1|2|3>`);
      return;
    }

    console.log(`
ğŸš€ Phase ${phaseNumber} ì‹¤í–‰ ì‹œì‘...

Claude Codeì— ë‹¤ìŒê³¼ ê°™ì´ ìš”ì²­í•˜ì„¸ìš”:

  "vide run --phase ${phaseNumber} ì‹¤í–‰í•´ì¤˜. TASKS ë¬¸ì„œì˜ Phase ${phaseNumber} Taskë“¤ì„ ìˆœì°¨ì ìœ¼ë¡œ êµ¬í˜„í•´ì¤˜."

Phase ${phaseNumber} ì‘ì—… ëª©ë¡:
  ${getPhaseTaskList(phaseNumber)}

ì˜ˆìƒ ì‹œê°„: ${getPhaseEstimatedTime(phaseNumber)}
    `);
    return;
  }

  // íŠ¹ì • Task ì‹¤í–‰
  const taskId = option;
  console.log(`
ğŸš€ Task ì‹¤í–‰: "${taskId}"

Claude Codeì— ë‹¤ìŒê³¼ ê°™ì´ ìš”ì²­í•˜ì„¸ìš”:

  "vide run '${taskId}' ì‹¤í–‰í•´ì¤˜. ë‹¤ìŒ ìˆœì„œë¡œ ì§„í–‰í•´ì¤˜:

  1. TASKS ë¬¸ì„œì—ì„œ '${taskId}' ì°¾ê¸°
  2. êµ¬í˜„ ê°€ì´ë“œ ìƒì„± (.vide/guides/${taskId}.md)
  3. ê°€ì´ë“œì— ë”°ë¼ ì½”ë“œ êµ¬í˜„
  4. Acceptance Criteria ê²€ì¦
  5. Task ìƒíƒœë¥¼ âœ… ì™„ë£Œë¡œ ì—…ë°ì´íŠ¸"

êµ¬í˜„ ê°€ì´ë“œ ìƒì„± ìœ„ì¹˜:
  .vide/guides/${taskId.replace(/\s+/g, '-').toLowerCase()}.md

ê²€ì¦ ëª…ë ¹ì–´ëŠ” TASKS ë¬¸ì„œ ì°¸ê³ 
  `);
}

// Phaseë³„ Task ëª©ë¡ (í•˜ë“œì½”ë”© - ì¶”í›„ TASKS íŒŒì¼ì—ì„œ íŒŒì‹±)
function getPhaseTaskList(phase) {
  const phases = {
    '1': 'Task 1-1 ~ 1-8 (Backend ê°œë°œ)',
    '2': 'Task 2-1 ~ 2-8 (Frontend ê°œë°œ)',
    '3': 'Task 3-1 ~ 3-3 (FCM ì—°ë™ ë° í…ŒìŠ¤íŠ¸)'
  };
  return phases[phase] || 'ì•Œ ìˆ˜ ì—†ëŠ” Phase';
}

// Phaseë³„ ì˜ˆìƒ ì‹œê°„
function getPhaseEstimatedTime(phase) {
  const times = {
    '1': '8ì‹œê°„ (1ì¼)',
    '2': '12ì‹œê°„ (1.5ì¼)',
    '3': '4ì‹œê°„ (0.5ì¼)'
  };
  return times[phase] || 'ì•Œ ìˆ˜ ì—†ìŒ';
}
