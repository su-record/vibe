#!/usr/bin/env node

/**
 * sutory CLI
 * Your story becomes code
 */

const path = require('path');
const fs = require('fs');

// ëª…ë ¹ì–´ ëª©ë¡
const commands = {
  init: 'Initialize sutory in current project',
  story: 'Create/manage SPEC documents',
  plan: 'Create technical implementation plan',
  tasks: 'Break down SPEC into actionable tasks',
  implement: 'Start implementation with AI agents',
  verify: 'Verify implementation against SPEC',
  agents: 'List available agents',
  skills: 'List installed skills',
  update: 'Update sutory framework',
  help: 'Show help message'
};

const args = process.argv.slice(2);
const command = args[0];

// ë„ì›€ë§ ì¶œë ¥
function showHelp() {
  console.log(`
ğŸ“– sutory - Your story becomes code

Usage:
  sutory <command> [options]

Commands:
  init                           Initialize sutory in current project
  story create <name>            Create new SPEC through Q&A
  story list                     List all SPECs
  story show <name>              Show SPEC content
  plan <name>                    Create implementation plan from SPEC
  tasks <name>                   Generate tasks from SPEC + PLAN
  implement <name> [--agent]     Start implementation
  verify <name>                  Verify against SPEC requirements
  agents                         List available agents
  skills                         List installed skills
  update                         Update sutory framework
  help                           Show this message

Examples:
  $ sutory init
  $ sutory story create "User Authentication"
  $ sutory plan "User Authentication"
  $ sutory implement "User Authentication" --agent python

More info:
  https://github.com/your-username/sutory
  `);
}

// ë²„ì „ ì •ë³´
function showVersion() {
  const packageJson = require('../package.json');
  console.log(`sutory v${packageJson.version}`);
}

// í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
function init() {
  const sutoryDir = path.join(process.cwd(), '.sutory');

  if (fs.existsSync(sutoryDir)) {
    console.log('âŒ .sutory/ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
    return;
  }

  // í´ë” ìƒì„±
  fs.mkdirSync(sutoryDir);
  fs.mkdirSync(path.join(sutoryDir, 'specs'));
  fs.mkdirSync(path.join(sutoryDir, 'plans'));
  fs.mkdirSync(path.join(sutoryDir, 'tasks'));

  // constitution.md í…œí”Œë¦¿ ë³µì‚¬
  const templatePath = path.join(__dirname, '../templates/constitution-template.md');
  const constitutionPath = path.join(sutoryDir, 'constitution.md');

  if (fs.existsSync(templatePath)) {
    fs.copyFileSync(templatePath, constitutionPath);
  }

  // config.json ìƒì„± (ì–¸ì–´ ì„¤ì • í¬í•¨)
  const configPath = path.join(sutoryDir, 'config.json');
  const config = {
    language: 'ko',  // ê¸°ë³¸ í•œêµ­ì–´
    agents: {
      default: 'backend-python-expert'
    },
    mcp: {
      enabled: true,
      servers: ['hi-ai', 'context-7']
    },
    quality: {
      strict: true,
      autoVerify: true
    }
  };
  fs.writeFileSync(configPath, JSON.stringify(config, null, 2));

  console.log(`
âœ… sutory ì´ˆê¸°í™” ì™„ë£Œ!

ìƒì„±ëœ êµ¬ì¡°:
  .sutory/
  â”œâ”€â”€ config.json       # í”„ë¡œì íŠ¸ ì„¤ì • (ì–¸ì–´: í•œêµ­ì–´)
  â”œâ”€â”€ constitution.md    # í”„ë¡œì íŠ¸ ì›ì¹™
  â”œâ”€â”€ specs/            # SPEC ë¬¸ì„œë“¤
  â”œâ”€â”€ plans/            # ê¸°ìˆ  ê³„íšë“¤
  â””â”€â”€ tasks/            # ì‘ì—… ëª©ë¡ë“¤

ì–¸ì–´ ë³€ê²½:
  .sutory/config.jsonì—ì„œ "language"ë¥¼ "en" ë˜ëŠ” "ko"ë¡œ ë³€ê²½

ë‹¤ìŒ ë‹¨ê³„:
  sutory story create "ê¸°ëŠ¥ëª…"  - ìƒˆ ê¸°ëŠ¥ ìŠ¤í† ë¦¬ ì‘ì„±
  `);
}

// ì—ì´ì „íŠ¸ ëª©ë¡
function listAgents() {
  const agentsDir = path.join(__dirname, '../agents');
  const agents = fs.readdirSync(agentsDir).filter(f => f.endsWith('.md'));

  console.log('\nğŸ¤– ì‚¬ìš© ê°€ëŠ¥í•œ ì—ì´ì „íŠ¸:\n');
  agents.forEach((agent, i) => {
    const name = agent.replace('.md', '');
    console.log(`  ${i + 1}. ${name}`);
  });
  console.log('');
}

// ìŠ¤í‚¬ ëª©ë¡
function listSkills() {
  const skillsDir = path.join(__dirname, '../skills');
  const categories = fs.readdirSync(skillsDir).filter(f => {
    return fs.statSync(path.join(skillsDir, f)).isDirectory();
  });

  console.log('\nğŸ“š ì„¤ì¹˜ëœ ìŠ¤í‚¬:\n');
  categories.forEach(category => {
    const skills = fs.readdirSync(path.join(skillsDir, category))
      .filter(f => f.endsWith('.md'));
    console.log(`  ${category}/`);
    skills.forEach(skill => {
      console.log(`    - ${skill.replace('.md', '')}`);
    });
  });
  console.log('');
}

// Claude Codeì™€ í†µí•© (ì¶”í›„ êµ¬í˜„)
function delegateToClaudeCode(command, args) {
  console.log(`
âš ï¸  ì´ ëª…ë ¹ì–´ëŠ” Claude Codeì™€ í†µí•©ì´ í•„ìš”í•©ë‹ˆë‹¤.

ì§€ê¸ˆì€ ìˆ˜ë™ìœ¼ë¡œ Claude Codeë¥¼ ì—´ê³  ë‹¤ìŒê³¼ ê°™ì´ ìš”ì²­í•˜ì„¸ìš”:

  "${command} ${args.join(' ')}"

í–¥í›„ ì—…ë°ì´íŠ¸ì—ì„œ ìë™í™”ë  ì˜ˆì •ì…ë‹ˆë‹¤.
  `);
}

// ë©”ì¸ ë¼ìš°í„°
switch (command) {
  case 'init':
    init();
    break;

  case 'agents':
    listAgents();
    break;

  case 'skills':
    listSkills();
    break;

  case 'version':
  case '-v':
  case '--version':
    showVersion();
    break;

  case 'help':
  case '-h':
  case '--help':
  case undefined:
    showHelp();
    break;

  // Claude Code ìœ„ì„ì´ í•„ìš”í•œ ëª…ë ¹ì–´ë“¤
  case 'story':
  case 'plan':
  case 'tasks':
  case 'implement':
  case 'verify':
    delegateToClaudeCode(command, args.slice(1));
    break;

  default:
    console.log(`âŒ ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: ${command}`);
    console.log('ì‚¬ìš©ë²•ì„ ë³´ë ¤ë©´: sutory help');
    process.exit(1);
}
